<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خرید و تمدید اشتراک Ay VPN | Ay Technic</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">


    <style>
        /* FONT & BASE STYLES */
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Bold.woff2') format('woff2');
            font-weight: 700;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Medium.woff2') format('woff2');
            font-weight: 500;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }
        :root {
            --font-family: 'Vazirmatn', sans-serif;
            --transition-speed: 0.3s;
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Gray */
            --success-color: #28a745; /* Green */
            --danger-color: #dc3545; /* Red */
            --warning-color: #ffc107; /* Yellow */
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-dark: #212529;
            --border-color: #dee2e6;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --plan-color: #007bff; /* Default for selected plan */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-light);
            color: var(--text-dark);
            direction: rtl;
            text-align: right;
            line-height: 1.6;
            padding-top: 50px;
            padding-bottom: 50px;
        }

        .container {
            width: 90%;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* HEADER */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        .header p {
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        /* TABS */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: color var(--transition-speed), border-bottom-color var(--transition-speed);
            color: var(--secondary-color);
            position: relative;
            z-index: 1;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 700;
        }

        /* TAB CONTENT */
        .tab-content {
            display: none;
            background-color: var(--bg-white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
        }

        .tab-content.active {
            display: block;
        }

        /* PLAN CARDS (BUY TAB) */
        .plan-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .plan-card {
            background-color: var(--bg-white);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            width: calc(33.333% - 14px);
            text-align: center;
            transition: all var(--transition-speed);
            cursor: pointer;
            position: relative;
        }

        .plan-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .plan-card.selected {
            border-color: var(--plan-color);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            transform: translateY(-5px);
        }

        .plan-card h3 {
            color: var(--primary-color);
            font-size: 1.6rem;
            margin-bottom: 10px;
        }

        .plan-card .price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .plan-card .price small {
            font-size: 1rem;
            font-weight: 500;
            color: var(--secondary-color);
        }

        .plan-card .feature-list {
            list-style: none;
            text-align: right;
            margin-bottom: 20px;
        }

        .plan-card .feature-list li {
            padding: 5px 0;
            font-size: 1rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .plan-card .feature-list li svg {
            color: var(--success-color);
            margin-left: 10px;
        }
        
        /* DYNAMIC SECTION (Users/Coupon/Summary) */
        .dynamic-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background-color: #f0f8ff; /* Light Blue BG */
            display: none; /* Initially hidden */
        }
        
        .dynamic-section h4 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* FORM STYLES */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-family);
            font-size: 1rem;
        }
        
        .form-group select {
            cursor: pointer;
        }
        
        .coupon-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .coupon-group input {
            flex-grow: 1;
        }
        
        .coupon-group button {
            flex-shrink: 0;
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        
        .coupon-group button:hover:not(:disabled) {
            background-color: var(--primary-color);
        }
        
        /* SUMMARY BOX */
        .summary-box {
            background-color: var(--bg-white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            margin-top: 20px;
            border: 1px solid var(--primary-color);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dotted var(--border-color);
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid var(--primary-color);
        }
        
        /* ERROR/SUCCESS MESSAGES */
        .coupon-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: 500;
            display: none;
        }

        .coupon-error {
            background-color: #f8d7da;
            color: var(--danger-color);
            border: 1px solid #f5c6cb;
        }

        .coupon-success {
            background-color: #d4edda;
            color: var(--success-color);
            border: 1px solid #c3e6cb;
        }

        /* BUTTONS */
        .btn-primary {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            border: none;
            border-radius: 4px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
        }
        
        .btn-primary:disabled {
            background-color: #a0c3e7;
            cursor: not-allowed;
        }

        /* TRACKING TAB */
        #tracking-form {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }
        
        .tracking-results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: var(--bg-white);
            box-shadow: var(--shadow-sm);
        }
        
        .result-item {
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
            text-align: right;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-item strong {
            font-weight: 700;
            margin-left: 5px;
        }
        
        .result-item a {
            word-break: break-all;
        }


        /* RENEW TAB */
        #renewal-form {
             max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }
        
        .plan-selection-renew {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* FOOTER */
        .footer {
            text-align: center;
            padding-top: 40px;
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .plan-card {
                width: calc(50% - 10px);
            }
            .header h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 576px) {
            .plan-card {
                width: 100%;
            }
            .tab-button {
                padding: 10px 15px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <header class="header">
            <h1>خرید و تمدید اشتراک Ay VPN</h1>
            <p>سرویس پرسرعت و امن برای عبور از فیلترینگ | ارائه شده توسط Ay Technic</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'buy-tab')">🛒 خرید اشتراک</button>
            <button class="tab-button" onclick="openTab(event, 'renew-tab')">🔄 تمدید اشتراک</button>
            <button class="tab-button" onclick="openTab(event, 'track-tab')">🔍 پیگیری سفارش</button>
        </div>

        <div id="buy-tab" class="tab-content active">
            
            <h4>۱. انتخاب پلن</h4>
            <div class="plan-cards">
                <div class="plan-card" data-plan-code="1M" data-base-amount="1200000" data-duration="1 ماهه" onclick="selectPlan(this)">
                    <h3>💎 ۱ ماهه</h3>
                    <div class="price">۱۲۰,۰۰۰ <small>تومان</small></div>
                    <ul class="feature-list">
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> اتصال یکپارچه</li>
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> سرورهای متعدد</li>
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> پشتیبانی ۲۴/۷</li>
                    </ul>
                </div>
                
                <div class="plan-card" data-plan-code="3M" data-base-amount="3400000" data-duration="۳ ماهه" onclick="selectPlan(this)">
                    <h3>🌟 ۳ ماهه</h3>
                    <div class="price">۳۴۰,۰۰۰ <small>تومان</small></div>
                     <ul class="feature-list">
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> اتصال یکپارچه</li>
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> سرورهای متعدد</li>
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> پشتیبانی ۲۴/۷</li>
                    </ul>
                </div>
                
                <div class="plan-card" data-plan-code="1Y" data-base-amount="10000000" data-duration="۱ ساله" onclick="selectPlan(this)">
                    <h3>👑 ۱ ساله</h3>
                    <div class="price">۱,۰۰۰,۰۰۰ <small>تومان</small></div>
                     <ul class="feature-list">
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> اتصال یکپارچه</li>
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> سرورهای متعدد</li>
                        <li><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="m9 11 3 3L22 4"></path></svg> پشتیبانی ۲۴/۷</li>
                    </ul>
                </div>
                
                <div class="plan-card" data-plan-code="2M" data-base-amount="2200000" data-duration="۲ ماهه" onclick="selectPlan(this)">
                    <h3>🚀 ۲ ماهه</h3>
                    <div class="price">۲۲۰,۰۰۰ <small>تومان</small></div>
                    <ul class="feature-list">
                        <li>...</li>
                    </ul>
                </div>
                <div class="plan-card" data-plan-code="6M" data-base-amount="6000000" data-duration="۶ ماهه" onclick="selectPlan(this)">
                    <h3>🔥 ۶ ماهه</h3>
                    <div class="price">۶۰۰,۰۰۰ <small>تومان</small></div>
                    <ul class="feature-list">
                        <li>...</li>
                    </ul>
                </div>
                <div class="plan-card" data-plan-code="2Y" data-base-amount="20000000" data-duration="۲ ساله" onclick="selectPlan(this)">
                    <h3>⭐ ۲ ساله</h3>
                    <div class="price">۲,۰۰۰,۰۰۰ <small>تومان</small></div>
                    <ul class="feature-list">
                        <li>...</li>
                    </ul>
                </div>
                
            </div>
            
            <form id="purchase-form">
                <div id="dynamic-section" class="dynamic-section">
                    
                    <h4>۲. مشخصات سفارش</h4>

                    <div class="form-group">
                        <label for="users">🔢 تعداد کاربر (۱ تا ۱۰ نفر):</label>
                        <select id="users" name="users" required onchange="updateSummary()">
                            <option value="1">۱ کاربر</option>
                            <option value="2">۲ کاربر (۵۰٪ تخفیف کاربر دوم)</option>
                            <option value="3">۳ کاربر (۵۰٪ تخفیف کاربران بعدی)</option>
                            <option value="4">۴ کاربر</option>
                            <option value="5">۵ کاربر</option>
                            <option value="6">۶ کاربر</option>
                            <option value="7">۷ کاربر</option>
                            <option value="8">۸ کاربر</option>
                            <option value="9">۹ کاربر</option>
                            <option value="10">۱۰ کاربر</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="coupenCode">🎫 کد تخفیف (اختیاری):</label>
                        <div class="coupon-group">
                            <input type="text" id="coupenCode" name="coupenCode" placeholder="کد تخفیف خود را وارد کنید" oninput="clearCouponMessage()">
                            <button type="button" id="checkCouponBtn" onclick="checkCoupon()">اعمال</button>
                        </div>
                        <div id="couponMessage" class="coupon-message" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label for="email">📧 ایمیل یا شماره موبایل (برای پیگیری):</label>
                        <input type="text" id="email" name="email" placeholder="مثال: example@gmail.com یا 0912xxxxxxx" required>
                    </div>
                    
                    <input type="hidden" id="renewalIdentifier" name="renewalIdentifier" value="">
                    
                    <h4>۳. خلاصه فاکتور</h4>
                    <div class="summary-box">
                        <div class="summary-item"><span>پلن انتخابی:</span><span id="summary-plan">-</span></div>
                        <div class="summary-item"><span>تعداد کاربران:</span><span id="summary-users">-</span></div>
                        <div class="summary-item"><span>مبلغ پایه:</span><span id="summary-base-amount">-</span></div>
                        <div class="summary-item" id="summary-discount-row" style="display: none;"><span>تخفیف کوپن:</span><span id="summary-discount-value" style="color: var(--success-color);">-</span></div>
                        <div class="summary-item"><span>مبلغ نهایی پرداخت (تومان):</span><span id="summary-final-amount" data-final-amount="0">۰</span></div>
                    </div>
                    
                    <button type="submit" id="payButton" class="btn-primary" disabled>
                        <i class="fa fa-shopping-cart"></i> ادامه و پرداخت ۰ تومان
                    </button>
                </div>
            </form>

        </div>

        <div id="renew-tab" class="tab-content">
            <form id="renewal-form">
                <h4>۱. مشخصات تمدید</h4>
                <div class="form-group">
                    <label for="renewId">🔄 شناسه اشتراک یا ایمیل/شماره تماس ثبت شده:</label>
                    <input type="text" id="renewId" name="renewId" placeholder="شناسه یا مشخصات قبلی" required>
                </div>
                
                 <h4>۲. انتخاب پلن تمدید</h4>
                <div class="plan-selection-renew">
                    <div class="plan-card" data-plan-code="1M" data-base-amount="1200000" data-duration="۱ ماهه" onclick="selectRenewPlan(this)">
                        <h3>۱ ماهه</h3>
                        <div class="price">۱۲۰,۰۰۰ <small>تومان</small></div>
                    </div>
                    <div class="plan-card" data-plan-code="3M" data-base-amount="3400000" data-duration="۳ ماهه" onclick="selectRenewPlan(this)">
                         <h3>۳ ماهه</h3>
                        <div class="price">۳۴۰,۰۰۰ <small>تومان</small></div>
                    </div>
                    <div class="plan-card" data-plan-code="1Y" data-base-amount="10000000" data-duration="۱ ساله" onclick="selectRenewPlan(this)">
                         <h3>۱ ساله</h3>
                        <div class="price">۱,۰۰۰,۰۰۰ <small>تومان</small></div>
                    </div>
                    </div>
                
                <div id="dynamic-section-renew" class="dynamic-section" style="margin-top: 30px;">
                    <div class="form-group">
                        <label for="renew-users">🔢 تعداد کاربر:</label>
                        <select id="renew-users" name="users" required onchange="updateRenewSummary()">
                            </select>
                    </div>

                    <div class="form-group">
                        <label for="renew-coupenCode">🎫 کد تخفیف (اختیاری):</label>
                        <div class="coupon-group">
                            <input type="text" id="renew-coupenCode" name="coupenCode" placeholder="کد تخفیف خود را وارد کنید" oninput="clearRenewCouponMessage()">
                            <button type="button" id="checkRenewCouponBtn" onclick="checkRenewCoupon()">اعمال</button>
                        </div>
                        <div id="renewCouponMessage" class="coupon-message" style="display: none;"></div>
                    </div>

                    
                    <h4>۳. خلاصه فاکتور تمدید</h4>
                    <div class="summary-box">
                        <div class="summary-item"><span>پلن انتخابی:</span><span id="renew-summary-plan">-</span></div>
                        <div class="summary-item"><span>تعداد کاربران:</span><span id="renew-summary-users">-</span></div>
                        <div class="summary-item"><span>مبلغ پایه:</span><span id="renew-summary-base-amount">-</span></div>
                        <div class="summary-item" id="renew-summary-discount-row" style="display: none;"><span>تخفیف کوپن:</span><span id="renew-summary-discount-value" style="color: var(--success-color);">-</span></div>
                        <div class="summary-item"><span>مبلغ نهایی پرداخت (تومان):</span><span id="renew-summary-final-amount" data-final-amount="0">۰</span></div>
                    </div>
                    
                    <button type="submit" id="renewPayButton" class="btn-primary" disabled>
                        <i class="fa fa-shopping-cart"></i> ادامه و پرداخت ۰ تومان
                    </button>
                </div>
            </form>
        </div>


        <div id="track-tab" class="tab-content">
            <form id="tracking-form">
                <h4>🔍 پیگیری سفارش با شناسه</h4>
                <div class="form-group">
                    <label for="trackingId">شناسه پیگیری (Tracking ID):</label>
                    <input type="text" id="trackingId" name="trackingId" placeholder="مثال: xxxxxxxxxxxx" required>
                </div>
                <button type="submit" id="trackButton" class="btn-primary">
                    <i class="fa fa-search"></i> پیگیری
                </button>
            </form>
            
            <div id="trackingResults" class="tracking-results" style="display: none;">
                </div>
        </div>

        <footer class="footer">
            <p>تمامی حقوق برای <a href="https://shammay.ir" target="_blank" style="color: var(--primary-color); text-decoration: none;">Ay Technic</a> محفوظ است. &copy; ۱۴۰۳</p>
        </footer>

    </div>

    <script>
        const APP_URL = window.location.origin; // آدرس سرور شما
        
        // --- داده‌های پلن‌ها ---
        // مبلغ به ریال ذخیره شده است تا هنگام ارسال به زرین‌پال نیازی به ضرب در ۱۰ نباشد.
        const plansData = [
            { duration: '۱ ماهه', baseAmount: 1200000, durationDays: 30, type: 'unlimited', icon: '💎', requestedPlan: '1M', basePriceToman: 120000 },
            { duration: '۲ ماهه', baseAmount: 2200000, durationDays: 60, type: 'unlimited', icon: '🚀', requestedPlan: '2M', basePriceToman: 220000 },
            { duration: '۳ ماهه', baseAmount: 3400000, durationDays: 90, type: 'unlimited', icon: '🌟', requestedPlan: '3M', basePriceToman: 340000 },
            { duration: '۶ ماهه', baseAmount: 6000000, durationDays: 180, type: 'unlimited', icon: '🔥', requestedPlan: '6M', basePriceToman: 600000 },
            { duration: '۱ ساله', baseAmount: 10000000, durationDays: 365, type: 'unlimited', icon: '👑', requestedPlan: '1Y', basePriceToman: 1000000 },
            { duration: '۲ ساله', baseAmount: 20000000, durationDays: 730, type: 'unlimited', icon: '⭐', requestedPlan: '2Y', basePriceToman: 2000000 },
        ];
        
        let selectedPlan = null; // برای خرید جدید
        let selectedRenewPlan = null; // برای تمدید
        
        // --- توابع کمکی ---

        // تابع محاسبه قیمت چند کاربره (مبلغ بر اساس ریال است)
        const calculateMultiUserPrice = (basePrice, users) => {
            // Price = Base Price + (Users - 1) * 50% of Base Price
            const multiplier = 1 + (users - 1) * 0.5;
            // گرد کردن به نزدیکترین ۱۰۰۰ تومان (۱۰,۰۰۰ ریال)
            return Math.round(basePrice * multiplier / 10000) * 10000; 
        };
        
        // تابع فرمت مبلغ
        const formatToman = (amount) => (amount / 10).toLocaleString('fa-IR') + ' تومان';
        
        // --- مدیریت تب‌ها ---
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // اگر به تب خرید جدید برویم، پلن تمدید را ریست می‌کنیم
            if (tabName === 'buy-tab') {
                 selectedRenewPlan = null;
                 document.getElementById('dynamic-section-renew').style.display = 'none';
                 document.getElementById('renewal-form').reset();
                 document.querySelectorAll('.plan-selection-renew .plan-card').forEach(card => card.classList.remove('selected'));
            }
            
            // اگر به تب تمدید برویم، پلن خرید جدید را ریست می‌کنیم
            if (tabName === 'renew-tab') {
                 selectedPlan = null;
                 document.getElementById('dynamic-section').style.display = 'none';
                 document.getElementById('purchase-form').reset();
                 document.querySelectorAll('.plan-cards .plan-card').forEach(card => card.classList.remove('selected'));
            }
            
            // اگر به تب پیگیری برویم، فرم‌های دیگر را ریست می‌کنیم (اختیاری)
            if (tabName === 'track-tab') {
                document.getElementById('trackingResults').style.display = 'none';
                document.getElementById('tracking-form').reset();
            }
            
             // مطمئن می‌شویم آیکون‌ها رندر شوند
            lucide.createIcons();
        }

        // --- توابع خرید جدید ---
        function selectPlan(card) {
            document.querySelectorAll('.plan-cards .plan-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            const planCode = card.getAttribute('data-plan-code');
            selectedPlan = plansData.find(p => p.requestedPlan === planCode);
            
            // نمایش بخش دینامیک (کاربر/کوپن/خلاصه)
            document.getElementById('dynamic-section').style.display = 'block';
            
            // ریست کردن کوپن و به‌روزرسانی خلاصه
            document.getElementById('coupenCode').value = '';
            document.getElementById('users').value = '1';
            clearCouponMessage();
            updateSummary();
        }

        function updateSummary() {
            if (!selectedPlan) return;
            
            const users = parseInt(document.getElementById('users').value);
            const baseAmount = selectedPlan.baseAmount;
            
            // ۱. محاسبه مبلغ چند کاربره
            const multiUserAmount = calculateMultiUserPrice(baseAmount, users); 
            
            // ۲. به‌روزرسانی خلاصه با مبلغ چند کاربره (ریالی)
            const couponMessageEl = document.getElementById('couponMessage');
            const summaryFinalAmountEl = document.getElementById('summary-final-amount');
            const summaryDiscountRowEl = document.getElementById('summary-discount-row');
            const payButton = document.getElementById('payButton');

            // ریست کوپن و مبلغ نهایی (تا زمانی که دوباره بررسی شود)
            summaryFinalAmountEl.setAttribute('data-final-amount', multiUserAmount);
            summaryFinalAmountEl.textContent = formatToman(multiUserAmount);
            summaryDiscountRowEl.style.display = 'none';
            couponMessageEl.style.display = 'none';
            
            // به‌روزرسانی سایر موارد
            document.getElementById('summary-plan').textContent = selectedPlan.duration;
            document.getElementById('summary-users').textContent = users + ' کاربر';
            document.getElementById('summary-base-amount').textContent = formatToman(baseAmount);

            payButton.disabled = false;
            payButton.innerHTML = `<i class="fa fa-shopping-cart"></i> ادامه و پرداخت ${formatToman(multiUserAmount)}`;
        }
        
        function clearCouponMessage() {
            document.getElementById('couponMessage').style.display = 'none';
        }

        async function checkCoupon() {
            const coupenCode = document.getElementById('coupenCode').value.trim();
            const originalAmount = Number(document.getElementById('summary-final-amount').getAttribute('data-final-amount'));
            const requestedPlan = selectedPlan ? selectedPlan.requestedPlan : null;
            
            const couponMessageEl = document.getElementById('couponMessage');
            const summaryFinalAmountEl = document.getElementById('summary-final-amount');
            const summaryDiscountRowEl = document.getElementById('summary-discount-row');
            const summaryDiscountValueEl = document.getElementById('summary-discount-value');
            const payButton = document.getElementById('payButton');
            const checkCouponBtn = document.getElementById('checkCouponBtn');
            const originalBtnText = checkCouponBtn.textContent;
            
            // اگر کوپن خالی است، ریست و بازگشت
            if (!coupenCode) {
                 updateSummary();
                 return;
            }

            if (!requestedPlan || originalAmount <= 0) {
                 couponMessageEl.className = 'coupon-message coupon-error';
                 couponMessageEl.textContent = 'لطفاً ابتدا پلن و تعداد کاربران را انتخاب کنید.';
                 couponMessageEl.style.display = 'block';
                 return;
            }
            
            // --- شروع پردازش کوپن ---
            checkCouponBtn.disabled = true;
            checkCouponBtn.textContent = 'در حال بررسی...';
            couponMessageEl.style.display = 'none';
            
            try {
                const response = await fetch(`${APP_URL}/api/coupen-check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        coupenCode: coupenCode,
                        requestedPlan: requestedPlan,
                        finalAmount: originalAmount // مبلغ چند کاربره (ریالی)
                    }),
                });

                const result = await response.json();
                
                // ریست کردن به حالت اولیه قبل از نمایش نتیجه
                updateSummary();

                if (result.success) {
                    const newAmount = result.newAmount;
                    const discountValue = result.discountValue;

                    // به‌روزرسانی UI با تخفیف
                    couponMessageEl.className = 'coupon-message coupon-success';
                    couponMessageEl.textContent = result.message;
                    
                    summaryFinalAmountEl.setAttribute('data-final-amount', newAmount);
                    summaryFinalAmountEl.textContent = result.formattedNewAmount;
                    
                    summaryDiscountRowEl.style.display = 'flex';
                    summaryDiscountValueEl.textContent = '-' + result.formattedDiscountValue;

                    payButton.innerHTML = `<i class="fa fa-shopping-cart"></i> ادامه و پرداخت ${result.formattedNewAmount}`;
                    
                } else {
                    // نمایش خطا و بازگشت به مبلغ اصلی
                    couponMessageEl.className = 'coupon-message coupon-error';
                    couponMessageEl.textContent = result.error || 'خطای ناشناخته در بررسی کوپن.';
                }
                
                couponMessageEl.style.display = 'block';

            } catch (error) {
                console.error('Coupon Check Error:', error);
                couponMessageEl.className = 'coupon-message coupon-error';
                couponMessageEl.textContent = 'خطای شبکه در اتصال به سرویس کوپن.';
                couponMessageEl.style.display = 'block';
                updateSummary(); // ریست به مبلغ اصلی
            } finally {
                checkCouponBtn.disabled = false;
                checkCouponBtn.textContent = originalBtnText;
            }
        }

        document.getElementById('purchase-form').addEventListener('submit', handlePurchase);
        
        async function handlePurchase(event) {
            event.preventDefault();
            
            if (!selectedPlan) {
                alert('لطفاً ابتدا یک پلن را انتخاب کنید.');
                return;
            }

            const payButton = document.getElementById('payButton');
            const originalText = payButton.innerHTML;
            
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> در حال اتصال به درگاه...';

            const form = event.target;
            const finalAmount = Number(document.getElementById('summary-final-amount').getAttribute('data-final-amount'));
            
            const postData = {
                amount: finalAmount, // مبلغ ریالی نهایی
                description: `خرید از طریق وب - پلن ${selectedPlan.requestedPlan} (${form.users.value} کاربره)`,
                email: form.email.value,
                renewalIdentifier: form.renewalIdentifier.value || '',
                requestedPlan: selectedPlan.requestedPlan,
                coupenCode: form.coupenCode.value.trim() || '',
                users: form.users.value,
            };
            
            try {
                const response = await fetch(`${APP_URL}/api/start-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });

                const result = await response.json();

                if (result.authority) {
                    const zarinpalUrl = `https://www.zarinpal.com/pg/StartPay/${result.authority}`;
                    window.location.href = zarinpalUrl;
                } else {
                    alert(`❌ خطا در شروع پرداخت: ${result.error || 'خطای ناشناخته'}`);
                }

            } catch (error) {
                console.error('Payment Error:', error);
                alert('❌ خطای شبکه یا سرور در شروع پرداخت. لطفاً دوباره تلاش کنید.');
            } finally {
                payButton.innerHTML = originalText;
                payButton.disabled = false;
            }
        }
        
        // --- توابع تمدید ---
        
        // پر کردن سکتور یوزرهای تمدید
        document.getElementById('renew-users').innerHTML = document.getElementById('users').innerHTML;
        
        function selectRenewPlan(card) {
            document.querySelectorAll('.plan-selection-renew .plan-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            const planCode = card.getAttribute('data-plan-code');
            selectedRenewPlan = plansData.find(p => p.requestedPlan === planCode);
            
            // نمایش بخش دینامیک تمدید
            document.getElementById('dynamic-section-renew').style.display = 'block';
            
            // ریست کردن کوپن و به‌روزرسانی خلاصه
            document.getElementById('renew-coupenCode').value = '';
            document.getElementById('renew-users').value = '1';
            clearRenewCouponMessage();
            updateRenewSummary();
        }
        
        function updateRenewSummary() {
             if (!selectedRenewPlan) return;
            
            const users = parseInt(document.getElementById('renew-users').value);
            const baseAmount = selectedRenewPlan.baseAmount;
            
            // ۱. محاسبه مبلغ چند کاربره
            const multiUserAmount = calculateMultiUserPrice(baseAmount, users); 
            
            // ۲. به‌روزرسانی خلاصه با مبلغ چند کاربره (ریالی)
            const couponMessageEl = document.getElementById('renewCouponMessage');
            const summaryFinalAmountEl = document.getElementById('renew-summary-final-amount');
            const summaryDiscountRowEl = document.getElementById('renew-summary-discount-row');
            const payButton = document.getElementById('renewPayButton');

            // ریست کوپن و مبلغ نهایی (تا زمانی که دوباره بررسی شود)
            summaryFinalAmountEl.setAttribute('data-final-amount', multiUserAmount);
            summaryFinalAmountEl.textContent = formatToman(multiUserAmount);
            summaryDiscountRowEl.style.display = 'none';
            couponMessageEl.style.display = 'none';
            
            // به‌روزرسانی سایر موارد
            document.getElementById('renew-summary-plan').textContent = selectedRenewPlan.duration;
            document.getElementById('renew-summary-users').textContent = users + ' کاربر';
            document.getElementById('renew-summary-base-amount').textContent = formatToman(baseAmount);

            payButton.disabled = false;
            payButton.innerHTML = `<i class="fa fa-shopping-cart"></i> ادامه و پرداخت ${formatToman(multiUserAmount)}`;
        }
        
        function clearRenewCouponMessage() {
             document.getElementById('renewCouponMessage').style.display = 'none';
        }
        
        async function checkRenewCoupon() {
             const coupenCode = document.getElementById('renew-coupenCode').value.trim();
            const originalAmount = Number(document.getElementById('renew-summary-final-amount').getAttribute('data-final-amount'));
            const requestedPlan = selectedRenewPlan ? selectedRenewPlan.requestedPlan : null;
            
            const couponMessageEl = document.getElementById('renewCouponMessage');
            const summaryFinalAmountEl = document.getElementById('renew-summary-final-amount');
            const summaryDiscountRowEl = document.getElementById('renew-summary-discount-row');
            const summaryDiscountValueEl = document.getElementById('renew-summary-discount-value');
            const payButton = document.getElementById('renewPayButton');
            const checkCouponBtn = document.getElementById('checkRenewCouponBtn');
            const originalBtnText = checkCouponBtn.textContent;
            
            if (!coupenCode) {
                 updateRenewSummary();
                 return;
            }

            if (!requestedPlan || originalAmount <= 0) {
                 couponMessageEl.className = 'coupon-message coupon-error';
                 couponMessageEl.textContent = 'لطفاً ابتدا پلن تمدید و تعداد کاربران را انتخاب کنید.';
                 couponMessageEl.style.display = 'block';
                 return;
            }
            
            // --- شروع پردازش کوپن ---
            checkCouponBtn.disabled = true;
            checkCouponBtn.textContent = 'در حال بررسی...';
            couponMessageEl.style.display = 'none';
            
            try {
                const response = await fetch(`${APP_URL}/api/coupen-check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        coupenCode: coupenCode,
                        requestedPlan: requestedPlan,
                        finalAmount: originalAmount // مبلغ چند کاربره (ریالی)
                    }),
                });

                const result = await response.json();
                
                // ریست کردن به حالت اولیه قبل از نمایش نتیجه
                updateRenewSummary();

                if (result.success) {
                    const newAmount = result.newAmount;
                    const discountValue = result.discountValue;

                    // به‌روزرسانی UI با تخفیف
                    couponMessageEl.className = 'coupon-message coupon-success';
                    couponMessageEl.textContent = result.message;
                    
                    summaryFinalAmountEl.setAttribute('data-final-amount', newAmount);
                    summaryFinalAmountEl.textContent = result.formattedNewAmount;
                    
                    summaryDiscountRowEl.style.display = 'flex';
                    summaryDiscountValueEl.textContent = '-' + result.formattedDiscountValue;

                    payButton.innerHTML = `<i class="fa fa-shopping-cart"></i> ادامه و پرداخت ${result.formattedNewAmount}`;
                    
                } else {
                    // نمایش خطا و بازگشت به مبلغ اصلی
                    couponMessageEl.className = 'coupon-message coupon-error';
                    couponMessageEl.textContent = result.error || 'خطای ناشناخته در بررسی کوپن.';
                }
                
                couponMessageEl.style.display = 'block';

            } catch (error) {
                console.error('Renew Coupon Check Error:', error);
                couponMessageEl.className = 'coupon-message coupon-error';
                couponMessageEl.textContent = 'خطای شبکه در اتصال به سرویس کوپن.';
                couponMessageEl.style.display = 'block';
                updateRenewSummary(); // ریست به مبلغ اصلی
            } finally {
                checkCouponBtn.disabled = false;
                checkCouponBtn.textContent = originalBtnText;
            }
        }
        
        document.getElementById('renewal-form').addEventListener('submit', handleRenewal);

        async function handleRenewal(event) {
            event.preventDefault();
            
            if (!selectedRenewPlan) {
                alert('لطفاً ابتدا یک پلن برای تمدید انتخاب کنید.');
                return;
            }

            const payButton = document.getElementById('renewPayButton');
            const originalText = payButton.innerHTML;
            
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> در حال اتصال به درگاه...';

            const form = event.target;
            const finalAmount = Number(document.getElementById('renew-summary-final-amount').getAttribute('data-final-amount'));
            
            const postData = {
                amount: finalAmount, // مبلغ ریالی نهایی
                description: `تمدید از طریق وب - پلن ${selectedRenewPlan.requestedPlan} (${form['users'].value} کاربره)`,
                renewalIdentifier: form.renewId.value, // شناسه/ایمیل/شماره تماس قبلی
                requestedPlan: selectedRenewPlan.requestedPlan,
                coupenCode: form['coupenCode'].value.trim() || '',
                users: form['users'].value,
                // برای تمدید، ایمیل را خالی می‌گذاریم یا از renewId استفاده می‌کنیم اگر ایمیل باشد.
                email: form.renewId.value.includes('@') ? form.renewId.value : '' 
            };
            
            try {
                const response = await fetch(`${APP_URL}/api/start-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });

                const result = await response.json();

                if (result.authority) {
                    const zarinpalUrl = `https://www.zarinpal.com/pg/StartPay/${result.authority}`;
                    window.location.href = zarinpalUrl;
                } else {
                    alert(`❌ خطا در شروع پرداخت: ${result.error || 'خطای ناشناخته'}`);
                }

            } catch (error) {
                console.error('Renewal Payment Error:', error);
                alert('❌ خطای شبکه یا سرور در شروع پرداخت. لطفاً دوباره تلاش کنید.');
            } finally {
                payButton.innerHTML = originalText;
                payButton.disabled = false;
            }
        }


        // --- توابع پیگیری سفارش (حذف Mockup) ---
        document.getElementById('tracking-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const trackingId = document.getElementById('trackingId').value.trim();
            const trackingResults = document.getElementById('trackingResults');
            const trackButton = document.getElementById('trackButton');
            const originalText = trackButton.innerHTML;
            
            if (!trackingId) return;

            trackButton.disabled = true;
            trackButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> در حال پیگیری...';
            trackingResults.style.display = 'none';
            trackingResults.innerHTML = '';
            
            try {
                // فراخوانی API واقعی پیگیری
                const response = await fetch(`${APP_URL}/api/track?trackingId=${trackingId}`);
                const result = await response.json();
                
                trackButton.innerHTML = originalText;
                trackButton.disabled = false;
                
                if (!response.ok || result.error) {
                    trackingResults.className = 'coupon-error tracking-results';
                    trackingResults.innerHTML = `<p>❌ سفارشی با شناسه **${trackingId}** یافت نشد.</p>`;
                } else {
                    let html = '<h3>✅ سفارشات یافت شده:</h3>';
                    
                    result.forEach(item => {
                        // تبدیل کد پلن به نام قابل خواندن
                        const planName = item.plan.endsWith('D') ? `${parseInt(item.plan)} روزه` : (item.plan === 'Renew' ? 'تمدید' : item.plan);
                        
                        html += `<div class="result-item">
                            <p><strong>پلن:</strong> ${planName}</p>
                            <p><strong>تاریخ خرید:</strong> ${item.date}</p>
                            <p><strong>لینک اشتراک:</strong> <a href="${item.link}" target="_blank">لینک دسترسی</a></p>
                            <p><strong>وضعیت:</strong> <span style="color: var(--success-color);">موفق</span></p>
                        </div>`;
                    });
                    trackingResults.className = 'coupon-success tracking-results';
                    trackingResults.innerHTML = html;
                }
                
                trackingResults.style.display = 'block';

            } catch (error) {
                console.error('Tracking fetch error:', error);
                trackButton.innerHTML = originalText;
                trackButton.disabled = false;
                trackingResults.className = 'coupon-error tracking-results';
                trackingResults.innerHTML = '<p>❌ خطای شبکه یا سرور در پیگیری سفارش.</p>';
                trackingResults.style.display = 'block';
            }
        });


        // اجرای اولیه: انتخاب تب خرید و رندر آیکون‌ها
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.tab-button').click(); // Show default tab
            lucide.createIcons();
            
            // رندر کردن آیکون‌های lucide در پلن کاردها (که در استایل پنهان بودند)
            document.querySelectorAll('.plan-card .feature-list li svg').forEach(icon => {
                icon.setAttribute('width', '20');
                icon.setAttribute('height', '20');
            });
        });
    </script>

</body>
</html>